REM PEG SOLITAIRE
REM  for MachiKania type Z/M/P
REM   by KENKEN

REM Global Variables
REM B():Board, Hole Staus
REM      0 No Hole
REM      1 Ball In
REM      2 Ball Out
REM G():Undo Buffer
REM X,Y:Cursor1 Position(red)
REM P,Q:Cursor2 Position(green)
REM N:Num of Balls
REM S:Step Number
REM K,L,M:Button Status
REM I,J:Other

DIM B(6,6),G(48,7)
USEGRAPHIC

REM Main Routine

GOSUB INIT
WHILE 1
 GOSUB GETUND
 GOSUB PUTBRD
 WHILE 1
  IF GOSUB(MOVE1) THEN BREAK
  IF GOSUB(MOVE2) THEN BREAK
  IF GOSUB(CHECK) THEN SOUND SOUND1:CONTINUE
  GOSUB MOVE3
  GOSUB SETUND
  GOSUB SCORE
  IF GOSUB(COMPLE) THEN BREAK
  SOUND SOUND4
 WEND
WEND

LABEL INIT
 REM Initialize and Start
 VAR I,J

 REM Set Color Palette
 RESTORE PALDAT
 FOR I=8 TO 15
  GPALETTE I,READ(),READ(),READ()
 NEXT
 GCLS
 BOXFILL 0,0,223,223,8
 GPRINT 172,20,7,-1,"BALLS"
 GPRINT 160,162,7,-1,"FIRE:"
 GPRINT 176,172,7,-1,"SELECT"
 GPRINT 160,182,7,-1,"START:"
 GPRINT 176,192,7,-1,"BACK"
 GPRINT 160,202,7,-1,"START 2s"
 GPRINT 176,212,7,-1,"RESET"

 RESTORE BOARD
 FOR I=0 TO 6
  FOR J=0 TO 6
   B(I,J)=READ()
  NEXT
 NEXT
 GOSUB SETUND
 GOSUB INIT2
 K=63
RETURN

LABEL PUTBRD
 REM Redraw Board
 VAR I,J
 N=0
 FOR I=0 TO 6
  FOR J=0 TO 6
   IF B(I,J)=1 THEN
    PUTBMP J*32,I*32,32,32,BMP1
    N=N+1
   ELSEIF B(I,J)=2 THEN
    PUTBMP J*32,I*32,32,32,BMP2
   ENDIF
  NEXT
 NEXT
 GOSUB SCORE
RETURN

LABEL SCORE
 REM Print the Number of Balls Left
 IF N>=10 THEN GPRINT 184,30,7,8,DEC$(N) ELSE GPRINT 184,30,7,8," "+DEC$(N)
RETURN

LABEL MOVE1
 REM Move Cursor1(red)
 VAR U,V,F
 F=0
 WHILE 1
  GOSUB CURS,X,Y,2
  DO
   WAIT 1
   GOSUB INP
  LOOP WHILE L=0
  GOSUB CURS,X,Y,8
  IF L=16 THEN
   GOSUB UNDCHK
   F=1
   BREAK
  ENDIF
  IF L=32 AND B(Y,X)=1 THEN BREAK
  U=X:V=Y
  IF L=1 THEN V=V-1
  IF L=2 THEN V=V+1
  IF L=4 THEN U=U-1
  IF L=8 THEN U=U+1
  IF U<0 OR U>6 OR V<0 OR V>6 THEN CONTINUE
  IF B(V,U)=0 THEN CONTINUE
  X=U:Y=V
 WEND
 IF F=0 THEN SOUND SOUND3
RETURN F

LABEL MOVE2
 REM Move Cursor2(green)
 VAR U,V,F
 F=0
 P=X:Q=Y
 WHILE 1
  GOSUB CURS,X,Y,2
  GOSUB CURS,P,Q,4
  DO
   WAIT 1
   GOSUB INP
  LOOP WHILE L=0
  GOSUB CURS,X,Y,8
  GOSUB CURS,P,Q,8
  IF L=16 THEN
   GOSUB UNDCHK
   F=1
   BREAK
  ENDIF
  IF L=32 THEN BREAK
  U=P:V=Q
  IF L=1 THEN V=V-1
  IF L=2 THEN V=V+1
  IF L=4 THEN U=U-1
  IF L=8 THEN U=U+1
  IF U<0 OR U>6 OR V<0 OR V>6 THEN CONTINUE
  IF B(V,U)=0 THEN CONTINUE
  P=U:Q=V
 WEND
RETURN F

LABEL CHECK
 REM Move Check
 IF B(Q,P)!=2 THEN RETURN 1
 IF X=P THEN
  IF ABS(Y-Q)!=2 THEN RETURN 1
  IF B((Y+Q)/2,X)!=1 THEN RETURN 1
 ELSEIF Y=Q THEN
  IF ABS(X-P)!=2 THEN RETURN 1
  IF B(Y,(X+P)/2)!=1 THEN RETURN 1
 ELSE
  RETURN 1
 ENDIF
RETURN 0

LABEL MOVE3
 REM Move and Get Ball
 PUTBMP P*32,Q*32,32,32,BMP1
 PUTBMP X*32,Y*32,32,32,BMP2
 PUTBMP (X+P)/2*32,(Y+Q)/2*32,32,32,BMP2
 B(Q,P)=1
 B(Y,X)=2
 B((Y+Q)/2,(X+P)/2)=2
 N=N-1
 X=P:Y=Q
 S=S+1
RETURN

LABEL COMPLE
 REM Complete Check
 IF N>1 THEN RETURN 0
 GPRINT 48,108,6,-1,"CONGRATULATIONS!"
 GPRINT 72,130,7,-1,"PUSH START"
 GPRINT 60,140,7,-1,"TO PLAY AGAIN"
 GPRINT 52,150,7,-1,"OR FIRE TO QUIT"
 SOUND SOUND2
 WHILE 1
  WAIT 1
  GOSUB INP
  IF L=16 THEN BREAK
  IF L=32 THEN END
 WEND
 GOSUB INIT2
RETURN 1

LABEL UNDCHK
 REM Check Undo/Reset
 VAR T
 T=0
 WHILE T<120
  WAIT 1
  GOSUB INP
  IF K!=16 THEN BREAK
  T=T+1
 WEND
 IF T=120 THEN
  SOUND SOUND6
  GOSUB INIT2
 ELSE
  IF S>0 THEN S=S-1:SOUND SOUND5
 ENDIF
RETURN

LABEL INIT2
 S=0
 X=3
 Y=3
RETURN

LABEL GETUND
 VAR I,J,D
 FOR I=0 TO 6
  D=G(S,I)
  FOR J=0 TO 6
   B(I,J)=D AND 3
   D=D>>2
  NEXT
 NEXT
RETURN

LABEL SETUND
 VAR I,J,D
 FOR I=0 TO 6
 D=0
  FOR J=6 TO 0 STEP -1
   D=(D<<2)+B(I,J)
  NEXT
  G(S,I)=D
 NEXT
RETURN

LABEL INP
 REM Read Buttons
 M=K
 K=KEYS()
 L=M XOR 63 AND K
RETURN

LABEL CURS
 REM Draw Cursor
 VAR X,Y,C
 X=ARGS(1):Y=ARGS(2):C=ARGS(3)
 BOXFILL X*32,Y*32,X*32+1,Y*32+31,C
 BOXFILL X*32,Y*32,X*32+31,Y*32+1,C
 BOXFILL X*32+30,Y*32,X*32+31,Y*32+31,C
 BOXFILL X*32,Y*32+30,X*32+31,Y*32+31,C
RETURN

LABEL BOARD
DATA 0,0,1,1,1,0,0
DATA 0,0,1,1,1,0,0
DATA 1,1,1,1,1,1,1
DATA 1,1,1,2,1,1,1
DATA 1,1,1,1,1,1,1
DATA 0,0,1,1,1,0,0
DATA 0,0,1,1,1,0,0

LABEL SOUND1
DATA $64000,1
LABEL SOUND2
DATA $60800,$60C00,$61000,$61800,$62000
DATA $61800,$61000,$60C00,$60800,$60400,1
LABEL SOUND3
DATA $306E0,$30700,1
LABEL SOUND4
DATA $30B80,$30C00,1
LABEL SOUND5
DATA $30400,1
LABEL SOUND6
DATA $30400,$20000,$30400,1

LABEL PALDAT
DATA 185,122,87
DATA 34,177,76
DATA 136,0,21
DATA 255,255,255
DATA 128,0,0
DATA 0,0,0
DATA 0,0,0
DATA 0,0,0


REM Bitmap Data
REM BMP1:Ball, BMP2:Hole

LABEL BMP1
CDATA 8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,
8,8,8,8,8,8,9,9,9,9,9,9,9,9,11,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,
8,8,8,8,8,8,9,9,9,9,9,9,11,11,11,11,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,
8,8,8,8,8,9,9,9,9,9,9,11,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,
8,8,8,8,9,9,9,9,9,11,11,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,
8,8,8,8,9,9,9,9,9,11,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,
8,8,8,8,9,9,9,9,11,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,
8,8,8,9,9,9,9,9,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,9,9,9,9,11,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,9,9,9,9,11,11,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,9,9,9,9,9,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,9,9,9,9,9,11,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,8,8,
8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,8,8,
8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,8,8,
8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,8,8,8,
8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,12,8,8,8,
8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,8,8,8,8,
8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,12,12,12,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,12,12,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,12,12,12,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,12,12,12,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8

LABEL BMP2
CDATA 8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,10,10,10,10,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,10,10,10,10,10,10,10,10,10,10,10,10,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,10,10,10,10,10,8,8,8,8,8,8,8,8,10,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,10,10,10,10,10,8,8,8,8,8,8,8,8,8,8,8,10,10,8,8,8,8,8,8,8,
8,8,8,8,8,8,10,10,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,8,8,
8,8,8,8,8,8,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,8,8,
8,8,8,8,8,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,8,
8,8,8,8,10,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,
8,8,8,8,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,
8,8,8,8,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,
8,8,8,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,
8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,
8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,
8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,8,8,8,10,8,8,8,
8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,8,8,8,10,8,8,8,
8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,11,8,8,8,10,8,8,8,
8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,8,8,8,8,10,8,8,8,
8,8,8,8,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,11,8,8,8,10,8,8,8,8,
8,8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,11,11,8,8,8,8,10,8,8,8,8,
8,8,8,8,8,10,8,8,8,8,8,8,8,8,8,8,8,8,11,11,11,11,8,8,8,8,10,8,8,8,8,8,
8,8,8,8,8,8,10,8,8,8,8,8,8,8,8,8,8,11,11,8,8,8,8,8,8,10,8,8,8,8,8,8,
8,8,8,8,8,8,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,8,8,
8,8,8,8,8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,10,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,10,8,8,8,8,8,8,8,8,8,8,8,8,10,10,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,10,10,8,8,8,8,8,8,8,8,10,10,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,10,10,10,10,10,10,10,10,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8
